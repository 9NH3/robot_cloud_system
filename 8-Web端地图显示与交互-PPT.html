<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第八次课：Web端地图显示与交互 - PPT文档</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f0f0f0;
            overflow-x: hidden;
        }
        
        .ppt-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .nav-container {
            background-color: #2c3e50;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-container h1 {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        .nav-buttons button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .nav-buttons button:hover {
            background-color: #2980b9;
        }
        
        .slides-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
        }
        
        .slide {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin: 0 auto 30px;
            padding: 40px;
            width: 100%;
            max-width: 1024px;
            min-height: 80vh;
            position: relative;
        }
        
        .slide-title {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .slide-content {
            font-size: 1.2rem;
            line-height: 1.6;
        }
        
        .slide-content h3 {
            color: #3498db;
            margin: 20px 0 10px;
        }
        
        .slide-content h4 {
            color: #2c3e50;
            margin: 15px 0 8px;
        }
        
        .slide-content ul, .slide-content ol {
            margin: 10px 0 10px 30px;
        }
        
        .slide-content li {
            margin-bottom: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        th {
            background-color: #3498db;
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            line-height: 1.4;
            white-space: pre-wrap;
        }
        
        code {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .formula {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            text-align: center;
            font-style: italic;
            border-left: 4px solid #e74c3c;
        }
        
        .caption {
            font-style: italic;
            text-align: center;
            margin-top: 5px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .footer {
            text-align: center;
            padding: 10px;
            color: #7f8c8d;
            font-size: 0.9rem;
            position: absolute;
            bottom: 10px;
            width: 100%;
            left: 0;
        }
        
        .two-columns {
            display: flex;
            gap: 20px;
        }
        
        .two-columns > div {
            flex: 1;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .grid-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }
        
        @media (max-width: 768px) {
            .slide {
                padding: 20px;
                min-height: auto;
            }
            
            .two-columns {
                flex-direction: column;
            }
            
            .nav-container {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        /* 打印样式 */
        @media print {
            body {
                background-color: white;
            }
            
            .nav-container {
                display: none;
            }
            
            .slide {
                box-shadow: none;
                page-break-after: always;
                margin: 0;
                height: auto;
            }
            
            .slides-container {
                overflow: visible;
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="ppt-container">
        <div class="nav-container">
            <h1>第八次课：Web端地图显示与交互 - PPT文档</h1>
            <div class="nav-buttons">
                <button onclick="navigate('prev')">上一张</button>
                <button onclick="navigate('home')">回到首页</button>
                <button onclick="navigate('next')">下一张</button>
                <button onclick="exportToPDF()">导出PDF</button>
            </div>
        </div>
        
        <div class="slides-container" id="slides-container">
            <!-- 幻灯片开始 -->
            
            <!-- 封面页 -->
            <div class="slide" id="slide1">
                <h1 class="slide-title">第八次课：Web端地图显示与交互</h1>
                <div class="slide-content" style="text-align: center; margin-top: 100px;">
                    <h2>机器人物联网云控系统</h2>
                    <p style="margin-top: 50px; font-size: 1.5rem;">SLAM地图的Web可视化与用户交互</p>
                    <p style="margin-top: 100px;">机器人物联网云控系统课程</p>
                </div>
                <div class="footer">第 1 页</div>
            </div>
            
            <!-- 课程内容介绍 -->
            <div class="slide" id="slide2">
                <h2 class="slide-title">一、课程内容介绍</h2>
                <div class="slide-content">
                    <p>本次课程是机器人物联网云控系统的第八课，将SLAM建图系统扩展到Web可视化界面。</p>
                    
                    <h3>核心教学内容</h3>
                    <ul>
                        <li>OccupancyGrid地图数据结构：理解机器人地图的基本格式</li>
                        <li>Canvas高级渲染技术：高效可视化的关键技术</li>
                        <li>多级交互控制机制：缩放、拖拽、标记、编辑</li>
                        <li>导航点管理系统：创建、编辑、删除路径点</li>
                        <li>坐标转换算法：地图坐标与世界坐标的相互转换</li>
                    </ul>
                    
                    <h3>学习价值</h3>
                    <p>将SLAM构建的地图数据转化为直观的Web界面是云控系统的关键环节，为后续导航功能奠定基础。</p>
                </div>
                <div class="footer">第 2 页</div>
            </div>
            
            <!-- 学习目标 -->
            <div class="slide" id="slide3">
                <h2 class="slide-title">二、学习目标及与后续课程关联</h2>
                <div class="slide-content">
                    <h3>核心学习目标</h3>
                    <ul>
                        <li>掌握OccupancyGrid地图数据结构及其解析方法</li>
                        <li>实现基于Canvas的地图渲染引擎</li>
                        <li>开发完整的地图交互功能（缩放、拖拽、标记）</li>
                        <li>构建导航点管理系统</li>
                        <li>实现地图坐标与世界坐标的精确转换</li>
                        <li>集成ROS与Web服务的数据通信</li>
                    </ul>
                    
                    <h3>与后续课程的关联</h3>
                    <ul>
                        <li><strong>多机器人协作</strong>：Web地图为多机协同提供可视化基础</li>
                        <li><strong>任务管理系统</strong>：导航点是任务规划的基础元素</li>
                        <li><strong>云端控制</strong>：Web界面是云端控制的核心交互方式</li>
                    </ul>
                </div>
                <div class="footer">第 3 页</div>
            </div>
            
            <!-- 核心技术点1 -->
            <div class="slide" id="slide4">
                <h2 class="slide-title">三、核心技术点 - 地图数据结构与解析</h2>
                <div class="slide-content">
                    <h3>OccupancyGrid结构解析</h3>
                    
                    <pre><code># ROS地图数据结构
Header header       # 消息头
  uint32 seq        # 序列号
  time stamp        # 时间戳
  string frame_id   # 参考坐标系

MapMetaData info    # 地图元数据
  time map_load_time # 地图加载时间
  float32 resolution # 地图分辨率 (米/格)
  uint32 width       # 地图宽度 (格数)
  uint32 height      # 地图高度 (格数)
  Pose origin       # 地图原点位置
    Point position    # 位置坐标 (x,y,z)
      float32 x
      float32 y
      float32 z
    Quaternion orientation # 姿态(四元数)

int8[] data         # 网格占用数据
                   #  100: 占用 (障碍物区域)
                   #    0: 空闲 (可通行区域)
                   #   -1: 未知区域</code></pre>
                </div>
                <div class="footer">第 4 页</div>
            </div>
            
            <!-- 核心技术点2 -->
            <div class="slide" id="slide5">
                <h2 class="slide-title">三、核心技术点 - 地图数据结构特点</h2>
                <div class="slide-content">
                    <h3>数据结构关键点</h3>
                    
                    <table>
                        <tr>
                            <th>特性</th>
                            <th>描述</th>
                            <th>意义</th>
                        </tr>
                        <tr>
                            <td>二维数组存储</td>
                            <td>以行优先方式排列数据</td>
                            <td>优化内存访问效率</td>
                        </tr>
                        <tr>
                            <td>网格定位</td>
                            <td>每个网格对应世界位置的算法</td>
                            <td>实现坐标精确转换</td>
                        </tr>
                        <tr>
                            <td>内存优化</td>
                            <td>典型20m×20m地图需要约160KB内存</td>
                            <td>适合Web传输和渲染</td>
                        </tr>
                        <tr>
                            <td>三维支持</td>
                            <td>frame_id可支持多层地图集成</td>
                            <td>支持复杂环境建模</td>
                        </tr>
                    </table>
                    
                    <h3>坐标转换公式</h3>
                    
                    <div class="formula">
                        像素坐标 → 世界坐标:
                        world_x = origin_x + (pixel_x + 0.5) * resolution
                        world_y = origin_y + (pixel_y + 0.5) * resolution
                    </div>
                    
                    <div class="formula">
                        世界坐标 → 像素坐标:
                        pixel_x = floor((world_x - origin_x) / resolution)
                        pixel_y = floor((world_y - origin_y) / resolution)
                    </div>
                </div>
                <div class="footer">第 5 页</div>
            </div>
            
            <!-- 核心技术点3 -->
            <div class="slide" id="slide6">
                <h2 class="slide-title">三、核心技术点 - 地图特征值统计</h2>
                <div class="slide-content">
                    <h3>地图特征值分析</h3>
                    
                    <table>
                        <tr>
                            <th>状态值</th>
                            <th>颜色</th>
                            <th>占总体比例</th>
                            <th>优化建议</th>
                        </tr>
                        <tr>
                            <td>100 (障碍物)</td>
                            <td style="background:#000;color:white;">黑色</td>
                            <td>30-45%</td>
                            <td>可做连通域分析减少噪声</td>
                        </tr>
                        <tr>
                            <td>0 (自由空间)</td>
                            <td style="background:#fff;">白色</td>
                            <td>30-50%</td>
                            <td>应用腐蚀膨胀平滑边缘</td>
                        </tr>
                        <tr>
                            <td>-1 (未知区域)</td>
                            <td style="background:#888;color:white;">灰色</td>
                            <td>5-40%</td>
                            <td>渐进式探索减小未知区域</td>
                        </tr>
                    </table>
                    
                    <h3>地图数据流动架构</h3>
                    
                    <table>
                        <tr>
                            <th>步骤</th>
                            <th>组件/角色</th>
                            <th>动作</th>
                            <th>结果/后续</th>
                        </tr>
                        <tr>
                            <td>1</td>
                            <td>ROS SLAM节点</td>
                            <td>发布地图话题(/map)</td>
                            <td>生成OccupancyGrid数据</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Web服务器</td>
                            <td>接收并处理地图数据</td>
                            <td>准备数据传输</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>数据转换处理</td>
                            <td>优化和转换数据格式</td>
                            <td>生成适合Web的数据</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>SocketIO/WSS传输</td>
                            <td>建立实时数据通道</td>
                            <td>数据发送到前端</td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>前端Canvas渲染</td>
                            <td>接收并渲染地图数据</td>
                            <td>交互式地图显示</td>
                        </tr>
                    </table>
                </div>
                <div class="footer">第 6 页</div>
            </div>
            
            <!-- 核心技术点4 -->
            <div class="slide" id="slide7">
                <h2 class="slide-title">三、核心技术点 - 地图渲染引擎技术</h2>
                <div class="slide-content">
                    <h3>Canvas渲染核心技术</h3>
                    
                    <pre><code>// 地图渲染核心函数
function renderOccupancyGrid(data) {
    const canvas = document.getElementById('map-canvas');
    const ctx = canvas.getContext('2d');
    
    // 创建离线Canvas提升性能
    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');
    tempCanvas.width = data.info.width;
    tempCanvas.height = data.info.height;
    
    // 创建ImageData对象高效填充像素
    const imgData = tempCtx.createImageData(data.width, data.height);
    
    // 使用预定义颜色映射加速渲染
    const COLOR_MAP = {
        100: [0, 0, 0, 255],    // 黑色 - 障碍物
        0: [255, 255, 255, 255],// 白色 - 空闲区域
        [-1]: [128, 128, 128, 255] // 灰色 - 未知区域
    };
    
    // 高效填充像素数据
    for (let i = 0, j = 0; i < data.data.length; i++, j += 4) {
        const cellValue = data.data[i];
        const color = COLOR_MAP[cellValue] || COLOR_MAP[-1];
        
        imgData.data[j] = color[0];     // R
        imgData.data[j + 1] = color[1]; // G
        imgData.data[j + 2] = color[2]; // B
        imgData.data[j + 3] = color[3]; // A
    }
    
    // 提交绘制命令
    tempCtx.putImageData(imgData, 0, 0);
    
    // 设置主Canvas尺寸
    canvas.width = data.info.width;
    canvas.height = data.info.height;
    
    // 缓存地图图像
    const renderedMap = new Image();
    renderedMap.src = tempCanvas.toDataURL();
    this.mapCache = renderedMap;
    
    // 渲染到主Canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(renderedMap, 0, 0);
    
    // 渲染坐标轴和导航点
    this.drawCoordinateSystem(ctx, data);
    this.drawWaypoints(ctx, this.waypoints);
    
    // 执行性能分析
    performance.mark('render_end');
    const measure = performance.measure('render_time', 'render_start', 'render_end');
    this.setRenderStats(measure.duration, data.data.length);
}</code></pre>
                </div>
                <div class="footer">第 7 页</div>
            </div>
            
            <!-- 核心技术点5 -->
            <div class="slide" id="slide8">
                <h2 class="slide-title">三、核心技术点 - 渲染优化技术</h2>
                <div class="slide-content">
                    <h3>渲染优化技术</h3>
                    
                    <table>
                        <tr>
                            <th>技术</th>
                            <th>描述</th>
                            <th>优势</th>
                        </tr>
                        <tr>
                            <td>离线Canvas</td>
                            <td>避免主Canvas渲染阻塞UI</td>
                            <td>提高界面响应速度</td>
                        </tr>
                        <tr>
                            <td>ImageData高效填充</td>
                            <td>像素级操作优于drawRect()</td>
                            <td>大幅提升渲染性能</td>
                        </tr>
                        <tr>
                            <td>颜色预定义</td>
                            <td>减少渲染条件判断</td>
                            <td>优化渲染逻辑</td>
                        </tr>
                        <tr>
                            <td>图像缓存</td>
                            <td>重复使用已渲染图像</td>
                            <td>减少重复计算</td>
                        </tr>
                        <tr>
                            <td>性能监控</td>
                            <td>实时显示渲染指标</td>
                            <td>便于性能优化</td>
                        </tr>
                    </table>
                    
                    <h3>多级渲染流程</h3>
                    
                    <table>
                        <tr>
                            <th>步骤</th>
                            <th>动作</th>
                            <th>条件</th>
                            <th>结果</th>
                        </tr>
                        <tr>
                            <td>1</td>
                            <td>开始渲染</td>
                            <td>地图数据更新</td>
                            <td>进入渲染流程</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>检查缓存</td>
                            <td>缓存有效/无效</td>
                            <td>决定渲染方式</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>执行差异渲染</td>
                            <td>缓存有效</td>
                            <td>只渲染变化部分</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>完整渲染</td>
                            <td>无缓存</td>
                            <td>全部重新渲染</td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>绘制坐标轴和导航点</td>
                            <td>渲染完成</td>
                            <td>添加辅助元素</td>
                        </tr>
                        <tr>
                            <td>6</td>
                            <td>性能分析</td>
                            <td>渲染结束</td>
                            <td>输出性能数据</td>
                        </tr>
                    </table>
                </div>
                <div class="footer">第 8 页</div>
            </div>
            
            <!-- 核心技术点6 -->
            <div class="slide" id="slide9">
                <h2 class="slide-title">三、核心技术点 - 地图交互功能设计</h2>
                <div class="slide-content">
                    <h3>交互功能</h3>
                    
                    <div class="grid">
                        <div class="grid-item">
                            <h4>拖拽操作</h4>
                            <p>左键拖拽平移地图</p>
                        </div>
                        <div class="grid-item">
                            <h4>放大缩小</h4>
                            <p>滚轮或按钮控制</p>
                        </div>
                        <div class="grid-item">
                            <h4>导航点标记</h4>
                            <p>右击放置路径点</p>
                        </div>
                        <div class="grid-item">
                            <h4>标签编辑</h4>
                            <p>双击点标记编辑名称</p>
                        </div>
                    </div>
                    
                    <h3>交互状态控制模型</h3>
                    
                    <table>
                        <tr>
                            <th>状态</th>
                            <th>触发条件</th>
                            <th>响应动作</th>
                            <th>退出条件</th>
                        </tr>
                        <tr>
                            <td>默认状态</td>
                            <td>系统启动</td>
                            <td>等待用户输入</td>
                            <td>用户操作</td>
                        </tr>
                        <tr>
                            <td>拖拽模式</td>
                            <td>左键按下</td>
                            <td>地图跟随鼠标移动</td>
                            <td>左键释放</td>
                        </tr>
                        <tr>
                            <td>标记模式</td>
                            <td>右键点击</td>
                            <td>放置导航点</td>
                            <td>右键释放</td>
                        </tr>
                        <tr>
                            <td>缩放模式</td>
                            <td>滚轮事件</td>
                            <td>地图缩放</td>
                            <td>滚轮停止</td>
                        </tr>
                        <tr>
                            <td>编辑模式</td>
                            <td>点击标记标签</td>
                            <td>编辑导航点信息</td>
                            <td>完成编辑或取消</td>
                        </tr>
                        <tr>
                            <td>删除操作</td>
                            <td>点击删除按钮</td>
                            <td>删除导航点</td>
                            <td>确认删除</td>
                        </tr>
                    </table>
                </div>
                <div class="footer">第 9 页</div>
            </div>
            
            <!-- 核心技术点7 -->
            <div class="slide" id="slide10">
                <h2 class="slide-title">三、核心技术点 - 导航点管理系统</h2>
                <div class="slide-content">
                    <h3>导航点数据结构</h3>
                    
                    <pre><code>class WaypointManager {
    constructor() {
        this.waypoints = []; // 存储所有路径点
        this.minDistance = 0.2; // 防止点过于接近
    }
    
    addWaypoint(x, y, label = '') {
        const id = this.nextId();
        const newPoint = {
            id,
            x, 
            y,
            label: label || `Point-${id}`,
            color: this.getDynamicColor(),
            timestamp: Date.now()
        };
        
        // 检查是否过近
        if (this.isTooClose(newPoint)) {
            return null;
        }
        
        this.waypoints.push(newPoint);
        return newPoint;
    }
    
    updateWaypoint(id, properties) {
        const index = this.findIndex(id);
        if (index !== -1) {
            this.waypoints[index] = {...this.waypoints[index], ...properties};
            return this.waypoints[index];
        }
        return null;
    }
    
    deleteWaypoint(id) {
        const index = this.findIndex(id);
        if (index !== -1) {
            return this.waypoints.splice(index, 1)[0];
        }
        return null;
    }
    
    nextId() {
        // 基于时间戳的全局唯一ID
        return Date.now() + Math.floor(Math.random() * 1000);
    }
    
    isTooClose(point) {
        // 检查与现有点的距离
        return this.waypoints.some(wp => {
            const dx = wp.x - point.x;
            const dy = wp.y - point.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            return dist < this.minDistance;
        });
    }
    
    getDynamicColor() {
        const colors = ['#e74c3c', '#3498db', '#2ecc71', '#9b59b6', '#f39c12'];
        return colors[this.waypoints.length % colors.length];
    }
    
    // 路径点数据持久化存储
    saveToLocalStorage() {
        localStorage.setItem('robot_waypoints', JSON.stringify(this.waypoints));
    }
    
    loadFromLocalStorage() {
        const data = localStorage.getItem('robot_waypoints');
        if (data) this.waypoints = JSON.parse(data);
    }
    
    // 将数据发送到服务器
    syncWithServer() {
        api.saveWaypoints(this.waypoints);
    }
}</code></pre>
                </div>
                <div class="footer">第 10 页</div>
            </div>
            
            <!-- 核心技术点8 -->
            <div class="slide" id="slide11">
                <h2 class="slide-title">三、核心技术点 - 导航点管理系统功能</h2>
                <div class="slide-content">
                    <h3>管理系统功能</h3>
                    
                    <table>
                        <tr>
                            <th>功能</th>
                            <th>描述</th>
                            <th>实现方法</th>
                        </tr>
                        <tr>
                            <td>点冲突检测</td>
                            <td>确保导航点间距合理</td>
                            <td>计算欧几里得距离</td>
                        </tr>
                        <tr>
                            <td>动态着色</td>
                            <td>不同点使用不同颜色</td>
                            <td>预定义颜色数组循环使用</td>
                        </tr>
                        <tr>
                            <td>唯一标识符</td>
                            <td>基于时间戳的全局ID系统</td>
                            <td>时间戳+随机数组合</td>
                        </tr>
                        <tr>
                            <td>数据持久化</td>
                            <td>本地存储+服务器同步</td>
                            <td>localStorage + API调用</td>
                        </tr>
                        <tr>
                            <td>完整API</td>
                            <td>提供增删改查完整接口</td>
                            <td>类方法封装</td>
                        </tr>
                    </table>
                    
                    <h3>导航点数据结构字段</h3>
                    
                    <table>
                        <tr>
                            <th>字段</th>
                            <th>类型</th>
                            <th>描述</th>
                        </tr>
                        <tr>
                            <td>id</td>
                            <td>Number</td>
                            <td>唯一标识符</td>
                        </tr>
                        <tr>
                            <td>x</td>
                            <td>Number</td>
                            <td>X坐标（世界坐标）</td>
                        </tr>
                        <tr>
                            <td>y</td>
                            <td>Number</td>
                            <td>Y坐标（世界坐标）</td>
                        </tr>
                        <tr>
                            <td>label</td>
                            <td>String</td>
                            <td>点标签/名称</td>
                        </tr>
                        <tr>
                            <td>color</td>
                            <td>String</td>
                            <td>显示颜色</td>
                        </tr>
                        <tr>
                            <td>timestamp</td>
                            <td>Number</td>
                            <td>创建时间戳</td>
                        </tr>
                    </table>
                </div>
                <div class="footer">第 11 页</div>
            </div>
            
            <!-- 动手实践部分1 -->
            <div class="slide" id="slide12">
                <h2 class="slide-title">四、学生动手实践部分</h2>
                <div class="slide-content">
                    <h3>实践任务：Web端地图显示与交互</h3>
                    <p>本实践任务将引导学生完成Web端地图显示与交互系统的开发，分为以下几个步骤：</p>
                    
                    <h4>步骤1：环境准备与数据获取</h4>
                    <ul>
                        <li>搭建ROS 2开发环境</li>
                        <li>配置地图数据发布节点</li>
                        <li>建立Web服务器与ROS的通信</li>
                        <li>测试数据流畅通性</li>
                    </ul>
                    
                    <h4>步骤2：实现地图渲染引擎</h4>
                    <ul>
                        <li>创建Canvas渲染组件</li>
                        <li>实现OccupancyGrid数据解析</li>
                        <li>开发基础地图渲染功能</li>
                        <li>优化渲染性能</li>
                    </ul>
                </div>
                <div class="footer">第 12 页</div>
            </div>
            
            <!-- 动手实践部分2 -->
            <div class="slide" id="slide13">
                <h2 class="slide-title">动手实践部分（续）</h2>
                <div class="slide-content">
                    <h4>步骤3：开发交互功能</h4>
                    <ul>
                        <li>实现地图拖拽功能</li>
                        <li>添加缩放控制</li>
                        <li>开发导航点标记系统</li>
                        <li>添加坐标显示功能</li>
                    </ul>
                    
                    <h4>步骤4：完善导航点管理系统</h4>
                    <ul>
                        <li>实现导航点的增删改查</li>
                        <li>添加导航点标签编辑功能</li>
                        <li>实现数据持久化存储</li>
                        <li>开发服务器同步功能</li>
                    </ul>
                    
                    <h4>步骤5：性能优化与测试</h4>
                    <ul>
                        <li>进行性能测试与分析</li>
                        <li>优化渲染和交互性能</li>
                        <li>测试不同地图尺寸的适应性</li>
                        <li>准备演示材料</li>
                    </ul>
                </div>
                <div class="footer">第 13 页</div>
            </div>
            
            <!-- 动手实践部分3 -->
            <div class="slide" id="slide14">
                <h2 class="slide-title">动手实践部分 - 地图服务器开发</h2>
                <div class="slide-content">
                    <h3>ROS与Web服务集成</h3>
                    
                    <pre><code>import rclpy
from rclpy.node import Node
from nav_msgs.msg import OccupancyGrid
import sqlite3
import os
import time
import threading
import socketio
import eventlet

class MapServer(Node):
    """地图数据服务节点"""
    
    def __init__(self):
        super().__init__('web_map_server')
        
        # 初始化数据库
        self.init_database()
        
        # 创建地图消息订阅
        self.map_sub = self.create_subscription(
            OccupancyGrid, 
            '/map',
            self.map_callback,
            10
        )
        
        # 启动Socket.IO服务器
        threading.Thread(target=self.start_socketio, daemon=True).start()
        
        self.get_logger().info("地图服务已启动")
    
    def init_database(self):
        """初始化导航点数据库"""
        self.db_path = 'navpoints.db'
        self.conn = sqlite3.connect(self.db_path)
        self.cursor = self.conn.cursor()
        
        # 创建表
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS waypoints (
                id INTEGER PRIMARY KEY,
                x REAL NOT NULL,
                y REAL NOT NULL,
                label TEXT NOT NULL,
                timestamp INTEGER NOT NULL
            )
        ''')
        self.conn.commit()
    
    def map_callback(self, msg):
        """处理地图更新"""
        # 地图数据简化处理
        slim_map = {
            'metadata': {
                'width': msg.info.width,
                'height': msg.info.height,
                'resolution': msg.info.resolution,
                'origin': {
                    'x': msg.info.origin.position.x,
                    'y': msg.info.origin.position.y
                }
            },
            'data': list(msg.data)  # 转换为列表
        }
        
        # 通过SocketIO转发给Web客户端
        try:
            sio.emit('map_update', slim_map)
            self.get_logger().info("地图已推送至Web客户端")
        except Exception as e:
            self.get_logger().error(f"发送地图错误: {e}")
        
        # 保存为文件
        self.save_as_image(slim_map)
    
    def start_socketio(self):
        """启动Socket.IO服务器"""
        sio = socketio.Server(async_mode='eventlet', cors_allowed_origins='*')
        app = socketio.WSGIApp(sio)
        
        # Web客户端连接事件
        @sio.event
        def connect(sid, environ):
            self.get_logger().info(f'客户端连接: {sid}')
            
            # 发送当前所有导航点
            sio.emit('waypoints_update', self.get_waypoints())
        
        # 处理添加导航点消息
        @sio.on('add_waypoint')
        def add_waypoint(sid, data):
            self.get_logger().info(f"添加导航点: {data}")
            
            # 插入数据库
            self.cursor.execute('''
                INSERT INTO waypoints (id, x, y, label, timestamp)
                VALUES (?, ?, ?, ?, ?)
            ''', (data['id'], data['x'], data['y'], data['label'], data['timestamp']))
            self.conn.commit()
            
            # 广播给所有客户端
            sio.emit('waypoint_added', data)
        
        # 处理删除导航点
        @sio.on('delete_waypoint')
        def delete_waypoint(sid, data):
            self.get_logger().info(f"删除导航点: ID={data['id']}")
            self.cursor.execute('DELETE FROM waypoints WHERE id=?', (data['id'],))
            self.conn.commit()
            sio.emit('waypoint_deleted', data)
        
        # 启动服务器
        eventlet.wsgi.server(eventlet.listen(('', 9090)), app)

    def get_waypoints(self):
        """从数据库获取所有导航点"""
        self.cursor.execute('SELECT * FROM waypoints')
        return [dict(row) for row in self.cursor.fetchall()]
    
    def __del__(self):
        """清理资源"""
        if self.conn:
            self.conn.close()

if __name__ == '__main__':
    rclpy.init()
    server = MapServer()
    try:
        rclpy.spin(server)
    finally:
        server.destroy_node()
        rclpy.shutdown()</code></pre>
                </div>
                <div class="footer">第 14 页</div>
            </div>
            
            <!-- 动手实践部分4 -->
            <div class="slide" id="slide15">
                <h2 class="slide-title">动手实践部分 - 服务器核心功能</h2>
                <div class="slide-content">
                    <h3>服务器核心功能</h3>
                    
                    <table>
                        <tr>
                            <th>功能</th>
                            <th>描述</th>
                            <th>实现方法</th>
                        </tr>
                        <tr>
                            <td>数据库集成</td>
                            <td>SQLite存储路径点</td>
                            <td>使用sqlite3库</td>
                        </tr>
                        <tr>
                            <td>实时通信</td>
                            <td>Socket.IO实现双向数据流</td>
                            <td>python-socketio库</td>
                        </tr>
                        <tr>
                            <td>资源优化</td>
                            <td>线程隔离ROS与Web服务器</td>
                            <td>多线程技术</td>
                        </tr>
                        <tr>
                            <td>状态通知</td>
                            <td>所有操作实时反馈给各客户端</td>
                            <td>Socket.IO广播机制</td>
                        </tr>
                        <tr>
                            <td>可靠存储</td>
                            <td>即使重启后路径点仍可恢复</td>
                            <td>数据库持久化</td>
                        </tr>
                    </table>
                    
                    <h3>地图数据简化处理</h3>
                    
                    <pre><code>def map_callback(self, msg):
    """处理地图更新"""
    # 地图数据简化处理
    slim_map = {
        'metadata': {
            'width': msg.info.width,
            'height': msg.info.height,
            'resolution': msg.info.resolution,
            'origin': {
                'x': msg.info.origin.position.x,
                'y': msg.info.origin.position.y
            }
        },
        'data': list(msg.data)  # 转换为列表
    }
    
    # 通过SocketIO转发给Web客户端
    try:
        sio.emit('map_update', slim_map)
        self.get_logger().info("地图已推送至Web客户端")
    except Exception as e:
        self.get_logger().error(f"发送地图错误: {e}")
    
    # 保存为文件
    self.save_as_image(slim_map)</code></pre>
                </div>
                <div class="footer">第 15 页</div>
            </div>
            
            <!-- 动手实践部分5 -->
            <div class="slide" id="slide16">
                <h2 class="slide-title">动手实践部分 - 前端交互系统实现</h2>
                <div class="slide-content">
                    <h3>地图交互引擎</h3>
                    
                    <pre><code>class MapInteraction {
    constructor(canvasId) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext('2d');
        this.state = {
            mapData: null,
            scale: 1.0,
            offset: { x: 0, y: 0 },
            mapOrigin: { x: 0, y: 0 },
            resolution: 0.05,
            isDragging: false,
            startDragPos: { x: 0, y: 0 },
            startDragOffset: { x: 0, y: 0 }
        };
        
        // 设置事件监听器
        this.setupListeners();
        
        // 获取导航点管理器
        this.wpManager = new WaypointManager();
        this.wpManager.loadFromLocalStorage();
    }
    
    setupListeners() {
        // 缩放控制
        this.canvas.addEventListener('wheel', e => this.handleZoom(e));
        
        // 拖拽控制
        this.canvas.addEventListener('mousedown', e => this.startDrag(e));
        this.canvas.addEventListener('mousemove', e => this.handleDrag(e));
        this.canvas.addEventListener('mouseup', e => this.endDrag());
        this.canvas.addEventListener('mouseleave', e => this.endDrag());
        
        // 导航点放置
        this.canvas.addEventListener('contextmenu', e => this.handleWaypointPlacement(e));
        
        // 键盘事件
        document.addEventListener('keydown', e => this.handleKeys(e));
    }
    
    handleZoom(e) {
        e.preventDefault();
        
        // 获取鼠标在地图上的位置（缩放前）
        const mousePos = this.getMousePosition(e);
        
        // 缩放因子
        const scaleFactor = 0.1;
        const oldScale = this.state.scale;
        const newScale = Math.max(0.1, 
                                Math.min(10.0, 
                                oldScale * (1 + (e.deltaY > 0 ? -scaleFactor : scaleFactor))));
        
        // 调整偏移量保持缩放焦点
        this.state.offset.x -= (mousePos.x / oldScale - mousePos.x / newScale) * newScale;
        this.state.offset.y -= (mousePos.y / oldScale - mousePos.y / newScale) * newScale;
        
        this.state.scale = newScale;
        this.render();
    }
    
    startDrag(e) {
        if (e.button === 0) { // 左键
            this.state.isDragging = true;
            this.state.startDragPos = { x: e.clientX, y: e.clientY };
            this.state.startDragOffset = { ...this.state.offset };
            this.canvas.style.cursor = "grabbing";
        }
    }
    
    handleDrag(e) {
        if (!this.state.isDragging) return;
        
        const deltaX = e.clientX - this.state.startDragPos.x;
        const deltaY = e.clientY - this.state.startDragPos.y;
        
        this.state.offset.x = this.state.startDragOffset.x + deltaX;
        this.state.offset.y = this.state.startDragOffset.y + deltaY;
        
        this.render();
    }
    
    handleWaypointPlacement(e) {
        e.preventDefault();
        
        // 获取世界坐标
        const mousePos = this.getMousePosition(e);
        const worldPos = {
            x: this.state.mapOrigin.x + (mousePos.x + 0.5) * this.state.resolution,
            y: this.state.mapOrigin.y + (mousePos.y + 0.5) * this.state.resolution
        };
        
        // 添加新导航点
        const newPoint = this.wpManager.addWaypoint(worldPos.x, worldPos.y);
        if (newPoint) {
            // 保存并同步
            this.wpManager.saveToLocalStorage();
            this.wpManager.syncWithServer();
            
            // 打开编辑框
            this.openLabelEditor(newPoint, e.clientX, e.clientY);
            this.render();
        }
    }
    
    render() {
        // 渲染地图、导航点、机器人位置等
        // ...
    }
    
    openLabelEditor(waypoint, screenX, screenY) {
        // 实现标签编辑界面
        // ...
    }
    
    // 其他辅助方法...
}

// 初始化地图交互系统
document.addEventListener('DOMContentLoaded', () => {
    const mapSystem = new MapInteraction('map-canvas');
    
    // 接收服务器数据
    socket.on('map_update', data => {
        mapSystem.mapData = data;
        mapSystem.render();
    });
    
    socket.on('waypoint_added', data => {
        mapSystem.wpManager.addWaypoint(
            data.x, data.y, data.label, false
        );
        mapSystem.render();
    });
});</code></pre>
                </div>
                <div class="footer">第 16 页</div>
            </div>
            
            <!-- 动手实践部分6 -->
            <div class="slide" id="slide17">
                <h2 class="slide-title">动手实践部分 - 交互引擎设计</h2>
                <div class="slide-content">
                    <h3>交互引擎设计特点</h3>
                    
                    <table>
                        <tr>
                            <th>特性</th>
                            <th>描述</th>
                            <th>优势</th>
                        </tr>
                        <tr>
                            <td>状态管理</td>
                            <td>集中维护地图状态信息</td>
                            <td>统一管理交互状态</td>
                        </tr>
                        <tr>
                            <td>事件分离</td>
                            <td>各类交互事件独立处理</td>
                            <td>代码结构清晰</td>
                        </tr>
                        <tr>
                            <td>坐标转换</td>
                            <td>像素⇄世界坐标精确转换</td>
                            <td>确保位置准确性</td>
                        </tr>
                        <tr>
                            <td>聚焦中心缩放</td>
                            <td>保持鼠标位置不变</td>
                            <td>提升用户体验</td>
                        </tr>
                        <tr>
                            <td>持久化集成</td>
                            <td>导航点与云服务协同</td>
                            <td>数据一致性</td>
                        </tr>
                    </table>
                    
                    <h3>事件处理流程</h3>
                    
                    <table>
                        <tr>
                            <th>事件类型</th>
                            <th>触发条件</th>
                            <th>处理函数</th>
                            <th>结果</th>
                        </tr>
                        <tr>
                            <td>滚轮事件</td>
                            <td>鼠标滚轮滚动</td>
                            <td>handleZoom()</td>
                            <td>地图缩放</td>
                        </tr>
                        <tr>
                            <td>鼠标按下</td>
                            <td>鼠标按钮按下</td>
                            <td>startDrag()</td>
                            <td>开始拖拽</td>
                        </tr>
                        <tr>
                            <td>鼠标移动</td>
                            <td>鼠标移动</td>
                            <td>handleDrag()</td>
                            <td>地图拖拽</td>
                        </tr>
                        <tr>
                            <td>鼠标释放</td>
                            <td>鼠标按钮释放</td>
                            <td>endDrag()</td>
                            <td>结束拖拽</td>
                        </tr>
                        <tr>
                            <td>右键点击</td>
                            <td>鼠标右键点击</td>
                            <td>handleWaypointPlacement()</td>
                            <td>放置导航点</td>
                        </tr>
                        <tr>
                            <td>键盘事件</td>
                            <td>键盘按键</td>
                            <td>handleKeys()</td>
                            <td>特殊功能触发</td>
                        </tr>
                    </table>
                </div>
                <div class="footer">第 17 页</div>
            </div>
            
            <!-- 考核方法 -->
            <div class="slide" id="slide18">
                <h2 class="slide-title">五、考核方法</h2>
                <div class="slide-content">
                    <h3>Web端地图显示与交互考核标准</h3>
                    <p>本次课程的考核将从以下几个方面进行评价：</p>
                    
                    <table>
                        <tr>
                            <th>考核项目</th>
                            <th>比例</th>
                            <th>评分标准</th>
                        </tr>
                        <tr>
                            <td>核心功能</td>
                            <td>50%</td>
                            <td>地图渲染、交互效率、导航点管理、坐标准确度</td>
                        </tr>
                        <tr>
                            <td>性能指标</td>
                            <td>30%</td>
                            <td>响应时间、资源占用、地图复杂度支持</td>
                        </tr>
                        <tr>
                            <td>技术实现</td>
                            <td>20%</td>
                            <td>代码架构、错误处理、可扩展性</td>
                        </tr>
                    </table>
                    
                    <h3>具体评分细则</h3>
                    <ul>
                        <li><strong>优秀(90-100分)</strong>：所有功能完美实现，代码结构清晰，交互流畅，系统稳定运行</li>
                        <li><strong>良好(80-89分)</strong>：主要功能实现，代码结构合理，交互基本流畅，系统基本稳定</li>
                        <li><strong>中等(70-79分)</strong>：基本功能实现，代码结构一般，交互有时卡顿，系统偶尔不稳定</li>
                    </ul>
                </div>
                <div class="footer">第 18 页</div>
            </div>
            
            <!-- 调试工具和调试方法1 -->
            <div class="slide" id="slide19">
                <h2 class="slide-title">六、调试工具和调试方法</h2>
                <div class="slide-content">
                    <h3>Web开发调试工具</h3>
                    
                    <pre><code>// 常用调试命令和工具
1. 浏览器开发者工具 (F12)
   - 元素检查：查看和修改DOM结构
   - 控制台：查看日志和错误信息
   - 网络面板：监控网络请求和响应
   - 性能面板：分析页面性能

2. ROS调试工具
   $ ros2 topic echo /map          # 查看地图话题数据
   $ ros2 topic hz /map           # 检查地图发布频率
   $ ros2 node list               # 查看运行中的节点
   $ ros2 service list            # 查看可用服务

3. 网络调试
   $ ping [ip地址]                # 检查网络连通性
   $ netstat -tulnp | grep 9090   # 检查端口占用情况
   $ curl http://localhost:9090   # 测试Web服务可用性</code></pre>
                    
                    <p><strong>调试工具：</strong> 提供从前端到后端的全面调试能力，帮助定位界面、性能和通信问题。</p>
                </div>
                <div class="footer">第 19 页</div>
            </div>
            
            <!-- 调试工具和调试方法2 -->
            <div class="slide" id="slide20">
                <h2 class="slide-title">调试工具和调试方法（续）</h2>
                <div class="slide-content">
                    <h3>常见问题与解决方法</h3>
                    
                    <table>
                        <tr>
                            <th>问题现象</th>
                            <th>可能原因</th>
                            <th>解决方案</th>
                        </tr>
                        <tr>
                            <td>地图显示空白</td>
                            <td>数据未正确传输或解析</td>
                            <td>检查网络连接和数据格式</td>
                        </tr>
                        <tr>
                            <td>交互卡顿</td>
                            <td>渲染性能不足</td>
                            <td>优化渲染算法，使用离屏Canvas</td>
                        </tr>
                        <tr>
                            <td>坐标转换错误</td>
                            <td>转换公式错误或参数不正确</td>
                            <td>检查转换公式和原始参数</td>
                        </tr>
                        <tr>
                            <td>导航点无法保存</td>
                            <td>数据库或存储问题</td>
                            <td>检查数据库连接和权限</td>
                        </tr>
                        <tr>
                            <td>实时通信中断</td>
                            <td>网络问题或服务器故障</td>
                            <td>检查网络连接和服务器状态</td>
                        </tr>
                    </table>
                    
                    <h3>性能优化建议</h3>
                    <ul>
                        <li>使用Web Worker处理大量计算，避免阻塞UI线程</li>
                        <li>实现地图分块加载，减少一次性渲染压力</li>
                        <li>使用requestAnimationFrame优化动画性能</li>
                        <li>对静态元素使用缓存，减少重复渲染</li>
                        <li>压缩传输数据，减少网络带宽占用</li>
                    </ul>
                </div>
                <div class="footer">第 20 页</div>
            </div>
            
            <!-- 课程总结 -->
            <div class="slide" id="slide21">
                <h2 class="slide-title">课程总结</h2>
                <div class="slide-content">
                    <h3>核心技术体系</h3>
                    <ul>
                        <li>OccupancyGrid地图数据结构与解析</li>
                        <li>Canvas高效渲染技术</li>
                        <li>多级交互控制机制</li>
                        <li>导航点管理系统</li>
                        <li>坐标转换算法</li>
                        <li>ROS与Web服务集成</li>
                    </ul>
                    
                    <h3>核心能力提升</h3>
                    <ul>
                        <li>Web前端与机器人系统集成能力</li>
                        <li>大数据量可视化优化能力</li>
                        <li>复杂交互设计实现能力</li>
                        <li>全栈开发调试能力</li>
                    </ul>
                    
                    <h3>后续学习建议</h3>
                    <p>建议学生继续深入学习WebGL高级渲染、WebSocket实时通信、以及复杂交互设计模式，进一步提升Web端机器人控制系统的开发能力。</p>
                </div>
                <div class="footer">第 21 页</div>
            </div>
            
            <!-- 幻灯片结束 -->
        </div>
    </div>

    <script>
        // 当前幻灯片索引
        let currentSlide = 1;
        const totalSlides = 21;
        
        // 导航函数
        function navigate(direction) {
            if (direction === 'next' && currentSlide < totalSlides) {
                currentSlide++;
            } else if (direction === 'prev' && currentSlide > 1) {
                currentSlide--;
            } else if (direction === 'home') {
                currentSlide = 1;
            }
            
            // 滚动到目标幻灯片
            const targetSlide = document.getElementById(`slide${currentSlide}`);
            if (targetSlide) {
                targetSlide.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // 导出PDF函数
        function exportToPDF() {
            const element = document.getElementById('slides-container');
            const opt = {
                margin: 10,
                filename: '第八次课-Web端地图显示与交互.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }
        
        // 添加键盘导航支持
        document.addEventListener('keydown', function(event) {
            if (event.key === 'ArrowRight' || event.key === 'PageDown') {
                navigate('next');
            } else if (event.key === 'ArrowLeft' || event.key === 'PageUp') {
                navigate('prev');
            } else if (event.key === 'Home') {
                navigate('home');
            }
        });
        
        // 初始滚动到第一页
        window.onload = function() {
            navigate('home');
        };
    </script>
</body>
</html>